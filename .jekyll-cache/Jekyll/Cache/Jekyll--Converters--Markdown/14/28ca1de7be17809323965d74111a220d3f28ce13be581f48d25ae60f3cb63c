I"ÃL<p>ì´ ê¸€ì—ì„œëŠ” <code class="language-plaintext highlighter-rouge">pandas</code>ë¥¼ ì´ìš©í•˜ì—¬ <code class="language-plaintext highlighter-rouge">json</code> ë°ì´í„°ë¥¼ ë¶„ì„í•˜ê¸° ì¢‹ì€ í˜•íƒœë¡œ ë³€í™˜í•˜ëŠ” ë°©ë²•ì— ëŒ€í•´ ì„¤ëª…í•©ë‹ˆë‹¤.</p>

<p>ë°ì´í„°ì˜ ì¶œì²˜ëŠ” <a href="http://jmcauley.ucsd.edu/data/amazon/links.html">UCSD Amazon Product Dataset</a>ì´ê³ , Amazonì˜ Data Scientistì¸ Eugene Yanì˜ <a href="https://eugeneyan.com/writing/recommender-systems-baseline-pytorch/">ê¸€</a>ì„ ì°¸ê³ í•˜ì˜€ìŠµë‹ˆë‹¤.</p>

<h2 id="ë°ì´í„°-ì†Œê°œ">ë°ì´í„° ì†Œê°œ</h2>

<p>ë³¸ ê¸€ì—ì„œ ì‚¬ìš©í•  ìƒí’ˆ ë°ì´í„°ì˜ í˜•íƒœëŠ” ë‹¤ìŒê³¼ ê°™ìŠµë‹ˆë‹¤.</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>{ 
"asin": "0000031852",
"title": "Girls Ballet Tutu Zebra Hot Pink",
"price": 3.17,
"imUrl": "http://ecx.images-amazon.com/images/I/51fAmVkTbyL._SY300_.jpg",
"relatedâ€:
    { "also_bought":[
		  	"B00JHONN1S",
		  	"B002BZX8Z6",
		  	"B00D2K1M3O", 
		  	...
		  	"B007R2RM8W"
                    ],
      "also_viewed":[ 
		  	"B002BZX8Z6",
		  	"B00JHONN1S",
		  	"B008F0SU0Y",
		  	...
		  	"B00BFXLZ8M"
                     ],
      "bought_together":[ 
		  	"B002BZX8Z6"
                     ]
    },
"salesRank":
    { 
      "Toys &amp; Games":211836
    },
"brand": "Coxlures",
"categories":[ 
	    [ "Sports &amp; Outdoors",
	      "Other Sports",
	      "Dance"
	    ]
    ]
}
</code></pre></div></div>

<div align="center">
  <i>Amazon product dataset</i>
</div>

<p>ìœ„ ë°ì´í„°ëŠ” ë‹¤ìŒ <a href="http://jmcauley.ucsd.edu/data/amazon/links.html">ë§í¬</a>ì—ì„œ ë‹¤ìš´ë°›ì„ ìˆ˜ ìˆìŠµë‹ˆë‹¤.</p>

<p>ì´ í˜ì´ì§€ì—ì„œ ë‹¤ìš´ë¡œë“œ í•  ìˆ˜ ìˆëŠ” ì—¬ëŸ¬ ë°ì´í„° ì¤‘ì—ì„œ, <em>meta_Electronics.json.gz</em>ë¥¼ ì‚¬ìš©í•˜ì˜€ìŠµë‹ˆë‹¤.</p>

<hr />
<h2 id="íŒŒì‹±parsingì´ë€">íŒŒì‹±(Parsing)ì´ë€?</h2>

<p><code class="language-plaintext highlighter-rouge">json</code> ë°ì´í„°ë¥¼ ì–´ë–»ê²Œ ë¶„ì„ì— ì‚¬ìš©í•  ìˆ˜ ìˆì„ê¹Œìš”?</p>

<p>ìœ„ì™€ ê°™ì€ ì†ŒìŠ¤íŒŒì¼ì„ ì‚¬ìš©ìê°€ í•´ì„í•˜ê¸° ì¢‹ì€ í˜•íƒœë¡œ ë³€í™˜í•˜ëŠ” ì‘ì—…ì„ <strong>íŒŒì‹±(parsing)</strong>ì´ë¼ê³  í•©ë‹ˆë‹¤.</p>

<p><strong>íŒŒì‹±(Parsing)</strong>ì€ ì†ŒìŠ¤íŒŒì¼ì„ ì˜ë¯¸ìˆëŠ” ë‹¨ì–´ì˜ ë‹¨ìœ„ë¡œ ì˜ë¼ì„œ í•´ì„í•˜ëŠ” ì‘ì—…ì„ ë§í•©ë‹ˆë‹¤.</p>

<p>íŒŒì‹±ì˜ ì˜ˆëŠ” ë‹¤ìŒê³¼ ê°™ìŠµë‹ˆë‹¤.</p>

<ul>
  <li>
    <p><code class="language-plaintext highlighter-rouge">printf("hello")</code>ë¼ëŠ” êµ¬ë¬¸ì„ <code class="language-plaintext highlighter-rouge">printf</code>ì™€ <code class="language-plaintext highlighter-rouge">(, ", hello, ", )</code>ë¡œ ë‹¨ì–´ì™€ ê¸°í˜¸ë“¤ì„ í•˜ë‚˜ì”© ë‚˜ëˆ„ê¸°</p>
  </li>
  <li>
    <p>ë¸Œë¼ìš°ì €ì—ì„œ HTMLì„ DOM íŠ¸ë¦¬ë¡œ ë³€í™˜</p>
  </li>
  <li>
    <p>ì–´ë–¤ dataë¥¼ ì›í•˜ëŠ” formìœ¼ë¡œ ë§Œë“¤ì–´ë‚´ëŠ” ì‘ì—…</p>
  </li>
</ul>

<p>ì´ì²˜ëŸ¼ dataë¥¼ ì´í•´í•˜ê¸° ì‰¬ìš´ í˜•íƒœë¡œ ë³€í™˜í•˜ëŠ” ì‘ì—…ì„ <strong>íŒŒì‹±</strong>ì´ë¼ê³  í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤.</p>

<hr />

<h2 id="pandasë¥¼-ì´ìš©í•˜ì—¬-json-ë°ì´í„°-íŒŒì‹±í•˜ê¸°">pandasë¥¼ ì´ìš©í•˜ì—¬ json ë°ì´í„° íŒŒì‹±í•˜ê¸°</h2>

<p>ìš©ëŸ‰ì´ í° <code class="language-plaintext highlighter-rouge">json</code> íŒŒì¼ì„ í•œë²ˆì— ì½ì–´ì„œ <code class="language-plaintext highlighter-rouge">dataframe</code>ìœ¼ë¡œ ë³€í™˜í•˜ëŠ” ê²ƒì€ ë¶ˆê°€ëŠ¥í•©ë‹ˆë‹¤.</p>

<p>ë”°ë¼ì„œ íŒŒì´ì¬ì˜ <code class="language-plaintext highlighter-rouge">generator</code>ë¥¼ ì‚¬ìš©í•˜ì—¬ í•œì¤„ì”© ì½ê³  ë³€í™˜í•˜ëŠ” ê²ƒì´ ì¢‹ìŠµë‹ˆë‹¤.</p>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">def</span> <span class="nf">parse</span><span class="p">(</span><span class="n">path</span><span class="p">:</span> <span class="nb">str</span><span class="p">):</span>
    <span class="n">g</span> <span class="o">=</span> <span class="n">gzip</span><span class="p">.</span><span class="nb">open</span><span class="p">(</span><span class="n">path</span><span class="p">,</span> <span class="s">"rb"</span><span class="p">)</span>
    <span class="k">for</span> <span class="n">l</span> <span class="ow">in</span> <span class="n">g</span><span class="p">:</span>
        <span class="k">yield</span> <span class="nb">eval</span><span class="p">(</span><span class="n">l</span><span class="p">)</span>
</code></pre></div></div>

<h3 id="eval"><code class="language-plaintext highlighter-rouge">eval</code></h3>

<p>ìœ„ ì½”ë“œì˜ <code class="language-plaintext highlighter-rouge">eval</code> í•¨ìˆ˜ëŠ” ë¬¸ìì—´ì„ ì‹¤í–‰í•˜ëŠ” í•¨ìˆ˜ ì…ë‹ˆë‹¤.</p>

<p><code class="language-plaintext highlighter-rouge">json</code>ì˜ <code class="language-plaintext highlighter-rouge">value</code>ê°’ì€ ë¬¸ìì—´ë¡œ ì €ì¥ë˜ì–´ ìˆê¸° ë•Œë¬¸ì—, ì´ë¥¼ <code class="language-plaintext highlighter-rouge">dictionary</code>ë¡œ ë³€í™˜í•˜ê¸° ìœ„í•´ì„œ <code class="language-plaintext highlighter-rouge">eval</code> í•¨ìˆ˜ë¥¼ ì‚¬ìš©í•©ë‹ˆë‹¤.</p>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nb">eval</span><span class="p">(</span><span class="sa">b</span><span class="s">"{'asin': '0132793040', 'imUrl': 'http://ecx.images-amazon.com/images/I/31JIPhp%2BGIL.jpg', 'categories': [['Electronics', 'Computers &amp; Accessories', 'Cables &amp; Accessories', 'Monitor Accessories']], 'title': 'Kelby Training DVD: Mastering Blend Modes in Adobe Photoshop CS5 By Corey Barker'}</span><span class="se">\n</span><span class="s">"</span><span class="p">)</span>
</code></pre></div></div>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>{'asin': '0132793040', 'imUrl': 'http://ecx.images-amazon.com/images/I/31JIPhp%2BGIL.jpg', 'categories': [['Electronics', 'Computers &amp; Accessories', 'Cables &amp; Accessories', 'Monitor Accessories']], 'title': 'Kelby Training DVD: Mastering Blend Modes in Adobe Photoshop CS5 By Corey Barker'}
</code></pre></div></div>

<div align="center">
  <i>eval í•¨ìˆ˜ì˜ í™œìš© ì˜ˆì‹œ</i>
</div>

<p>ìœ„ì—ì„œ ì •ì˜í•œ <code class="language-plaintext highlighter-rouge">parse</code> í•¨ìˆ˜ë¥¼ ì‚¬ìš©í•˜ì—¬, <code class="language-plaintext highlighter-rouge">json</code> ë°ì´í„°ë¥¼ <code class="language-plaintext highlighter-rouge">dataframe</code>ìœ¼ë¡œ ë³€ê²½í•˜ëŠ” ì½”ë“œëŠ” ë‹¤ìŒê³¼ ê°™ìŠµë‹ˆë‹¤.</p>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">def</span> <span class="nf">parse_json_to_df</span><span class="p">(</span><span class="n">path</span><span class="p">:</span> <span class="nb">str</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">pd</span><span class="p">.</span><span class="n">DataFrame</span><span class="p">:</span>
    <span class="n">i</span> <span class="o">=</span> <span class="mi">0</span>
    <span class="n">df_dict</span> <span class="o">=</span> <span class="p">{}</span>
    <span class="k">for</span> <span class="n">d</span> <span class="ow">in</span> <span class="n">parse</span><span class="p">(</span><span class="n">path</span><span class="p">):</span>
        <span class="n">df_dict</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="n">d</span>
        <span class="n">i</span> <span class="o">+=</span> <span class="mi">1</span>
        <span class="k">if</span> <span class="n">i</span> <span class="o">%</span> <span class="mi">100000</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
            <span class="n">logger</span><span class="p">.</span><span class="n">info</span><span class="p">(</span><span class="s">"Rows processed: {:,}"</span><span class="p">.</span><span class="nb">format</span><span class="p">(</span><span class="n">i</span><span class="p">))</span>

    <span class="n">df</span> <span class="o">=</span> <span class="n">pd</span><span class="p">.</span><span class="n">DataFrame</span><span class="p">.</span><span class="n">from_dict</span><span class="p">(</span><span class="n">df_dict</span><span class="p">,</span> <span class="n">orient</span><span class="o">=</span><span class="s">"index"</span><span class="p">)</span>
    <span class="n">df</span><span class="p">[</span><span class="s">"related"</span><span class="p">]</span> <span class="o">=</span> <span class="n">df</span><span class="p">[</span><span class="s">"related"</span><span class="p">].</span><span class="n">astype</span><span class="p">(</span><span class="nb">str</span><span class="p">)</span>
    <span class="n">df</span><span class="p">[</span><span class="s">"categories"</span><span class="p">]</span> <span class="o">=</span> <span class="n">df</span><span class="p">[</span><span class="s">"categories"</span><span class="p">].</span><span class="n">astype</span><span class="p">(</span><span class="nb">str</span><span class="p">)</span>
    <span class="n">df</span><span class="p">[</span><span class="s">"salesRank"</span><span class="p">]</span> <span class="o">=</span> <span class="n">df</span><span class="p">[</span><span class="s">"salesRank"</span><span class="p">].</span><span class="n">astype</span><span class="p">(</span><span class="nb">str</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">df</span>
</code></pre></div></div>

<h3 id="from_dict"><code class="language-plaintext highlighter-rouge">from_dict</code></h3>
<p><code class="language-plaintext highlighter-rouge">from_dict</code> í•¨ìˆ˜ëŠ” <code class="language-plaintext highlighter-rouge">dictionary</code>ë¥¼ <code class="language-plaintext highlighter-rouge">dataframe</code>ìœ¼ë¡œ ë³€í™˜ì‹œì¼œì£¼ëŠ” í•¨ìˆ˜ì…ë‹ˆë‹¤. ì˜ˆë¥¼ ë“¤ì–´,</p>
<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="n">df_dict</span> <span class="o">=</span> <span class="p">{</span><span class="mi">0</span><span class="p">:</span> <span class="p">{</span><span class="s">"a"</span><span class="p">:</span> <span class="mi">1</span><span class="p">,</span> <span class="s">"b"</span><span class="p">:</span> <span class="mi">2</span><span class="p">},</span> <span class="mi">1</span><span class="p">:</span> <span class="p">{</span><span class="s">"a"</span><span class="p">:</span> <span class="mi">3</span><span class="p">,</span> <span class="s">"b"</span><span class="p">:</span> <span class="mi">4</span><span class="p">}}</span>
<span class="n">pd</span><span class="p">.</span><span class="n">DataFrame</span><span class="p">.</span><span class="n">from_dict</span><span class="p">(</span><span class="n">df_dict</span><span class="p">)</span>
</code></pre></div></div>

<table>
  <thead>
    <tr>
      <th>Â </th>
      <th>0</th>
      <th>1</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <td>a</td>
      <td>1</td>
      <td>3</td>
    </tr>
    <tr>
      <td>b</td>
      <td>2</td>
      <td>4</td>
    </tr>
  </tbody>
</table>

<p><br /></p>

<p>ì™€ ê°™ì´ ì‚¬ìš©í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤. ì´ë•Œ <code class="language-plaintext highlighter-rouge">orient</code>ì˜ ê¸°ë³¸ê°’ì€ <code class="language-plaintext highlighter-rouge">columns</code>ì´ë©°, <code class="language-plaintext highlighter-rouge">dictionary</code>ì˜ í‚¤ë¥¼ ì—´ì˜ ë ˆì´ë¸”ë¡œ ì„¤ì •í•©ë‹ˆë‹¤.</p>

<p>ë§Œì¼ <code class="language-plaintext highlighter-rouge">orient='index'</code>ë¡œ ì„¤ì •í•˜ë©´ <code class="language-plaintext highlighter-rouge">dictionary</code>ì˜ í‚¤ë¥¼ í–‰ì˜ ë ˆì´ë¸”ë¡œ ì„¤ì •í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤.</p>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="n">df_dict</span> <span class="o">=</span> <span class="p">{</span><span class="mi">0</span><span class="p">:</span> <span class="p">{</span><span class="s">"a"</span><span class="p">:</span> <span class="mi">1</span><span class="p">,</span> <span class="s">"b"</span><span class="p">:</span> <span class="mi">2</span><span class="p">},</span> <span class="mi">1</span><span class="p">:</span> <span class="p">{</span><span class="s">"a"</span><span class="p">:</span> <span class="mi">3</span><span class="p">,</span> <span class="s">"b"</span><span class="p">:</span> <span class="mi">4</span><span class="p">}}</span>
<span class="n">pd</span><span class="p">.</span><span class="n">DataFrame</span><span class="p">.</span><span class="n">from_dict</span><span class="p">(</span><span class="n">df_dict</span><span class="p">,</span> <span class="p">,</span> <span class="n">orient</span><span class="o">=</span><span class="s">"index"</span><span class="p">)</span>
</code></pre></div></div>

<table>
  <thead>
    <tr>
      <th>Â </th>
      <th>a</th>
      <th>b</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <td>0</td>
      <td>1</td>
      <td>2</td>
    </tr>
    <tr>
      <td>1</td>
      <td>3</td>
      <td>4</td>
    </tr>
  </tbody>
</table>

<p>ì €í¬ë„ <code class="language-plaintext highlighter-rouge">orident="index"</code>ë¡œ ì„¤ì •í•˜ì—¬ ì½”ë“œë¥¼ ì‹¤í–‰í•˜ê² ìŠµë‹ˆë‹¤.</p>

<hr />

<p><br /></p>

<h2 id="ì „ì²´ì½”ë“œ">ì „ì²´ì½”ë“œ</h2>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kn">import</span> <span class="nn">gzip</span>
<span class="kn">import</span> <span class="nn">pandas</span> <span class="k">as</span> <span class="n">pd</span>
<span class="kn">import</span> <span class="nn">gzip</span>
<span class="kn">import</span> <span class="nn">logging</span>

<span class="n">logger</span> <span class="o">=</span> <span class="n">logging</span><span class="p">.</span><span class="n">getLogger</span><span class="p">(</span><span class="n">__name__</span><span class="p">)</span>
<span class="n">logger</span><span class="p">.</span><span class="n">setLevel</span><span class="p">(</span><span class="n">logging</span><span class="p">.</span><span class="n">INFO</span><span class="p">)</span>
<span class="n">formatter</span> <span class="o">=</span> <span class="n">logging</span><span class="p">.</span><span class="n">Formatter</span><span class="p">(</span><span class="s">"%(asctime)s - %(message)s"</span><span class="p">)</span>

<span class="c1"># create console handler and set level to info
</span><span class="n">ch</span> <span class="o">=</span> <span class="n">logging</span><span class="p">.</span><span class="n">StreamHandler</span><span class="p">()</span>
<span class="n">ch</span><span class="p">.</span><span class="n">setFormatter</span><span class="p">(</span><span class="n">formatter</span><span class="p">)</span>
<span class="n">ch</span><span class="p">.</span><span class="n">setLevel</span><span class="p">(</span><span class="n">logging</span><span class="p">.</span><span class="n">INFO</span><span class="p">)</span>

<span class="c1"># add ch to logger
</span><span class="n">logger</span><span class="p">.</span><span class="n">addHandler</span><span class="p">(</span><span class="n">ch</span><span class="p">)</span>

<span class="k">def</span> <span class="nf">parse</span><span class="p">(</span><span class="n">path</span><span class="p">:</span> <span class="nb">str</span><span class="p">):</span>
    <span class="n">g</span> <span class="o">=</span> <span class="n">gzip</span><span class="p">.</span><span class="nb">open</span><span class="p">(</span><span class="n">path</span><span class="p">,</span> <span class="s">"rb"</span><span class="p">)</span>
    <span class="k">for</span> <span class="n">l</span> <span class="ow">in</span> <span class="n">g</span><span class="p">:</span>
        <span class="k">yield</span> <span class="nb">eval</span><span class="p">(</span><span class="n">l</span><span class="p">)</span>

<span class="k">def</span> <span class="nf">parse_json_to_df</span><span class="p">(</span><span class="n">path</span><span class="p">:</span> <span class="nb">str</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">pd</span><span class="p">.</span><span class="n">DataFrame</span><span class="p">:</span>
    <span class="n">i</span> <span class="o">=</span> <span class="mi">0</span>
    <span class="n">df_dict</span> <span class="o">=</span> <span class="p">{}</span>
    <span class="k">for</span> <span class="n">d</span> <span class="ow">in</span> <span class="n">parse</span><span class="p">(</span><span class="n">path</span><span class="p">):</span>
        <span class="n">df_dict</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="n">d</span>
        <span class="n">i</span> <span class="o">+=</span> <span class="mi">1</span>
        <span class="k">if</span> <span class="n">i</span> <span class="o">%</span> <span class="mi">100000</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
            <span class="n">logger</span><span class="p">.</span><span class="n">info</span><span class="p">(</span><span class="s">"Rows processed: {:,}"</span><span class="p">.</span><span class="nb">format</span><span class="p">(</span><span class="n">i</span><span class="p">))</span>

    <span class="n">df</span> <span class="o">=</span> <span class="n">pd</span><span class="p">.</span><span class="n">DataFrame</span><span class="p">.</span><span class="n">from_dict</span><span class="p">(</span><span class="n">df_dict</span><span class="p">,</span> <span class="n">orient</span><span class="o">=</span><span class="s">"index"</span><span class="p">)</span>
    <span class="n">df</span><span class="p">[</span><span class="s">"related"</span><span class="p">]</span> <span class="o">=</span> <span class="n">df</span><span class="p">[</span><span class="s">"related"</span><span class="p">].</span><span class="n">astype</span><span class="p">(</span><span class="nb">str</span><span class="p">)</span>
    <span class="n">df</span><span class="p">[</span><span class="s">"categories"</span><span class="p">]</span> <span class="o">=</span> <span class="n">df</span><span class="p">[</span><span class="s">"categories"</span><span class="p">].</span><span class="n">astype</span><span class="p">(</span><span class="nb">str</span><span class="p">)</span>
    <span class="n">df</span><span class="p">[</span><span class="s">"salesRank"</span><span class="p">]</span> <span class="o">=</span> <span class="n">df</span><span class="p">[</span><span class="s">"salesRank"</span><span class="p">].</span><span class="n">astype</span><span class="p">(</span><span class="nb">str</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">df</span>

<span class="n">parse_json_to_df</span><span class="p">(</span><span class="s">"../../save/meta_Electronics.json.gz"</span><span class="p">)</span>
</code></pre></div></div>

<h2 id="ì‹¤í–‰ê²°ê³¼">ì‹¤í–‰ê²°ê³¼</h2>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>2021-03-19 12:06:36,158 - Rows processed: 100,000
2021-03-19 12:06:44,236 - Rows processed: 200,000
2021-03-19 12:06:53,033 - Rows processed: 300,000
2021-03-19 12:07:02,418 - Rows processed: 400,000
</code></pre></div></div>

<p><img src="https://user-images.githubusercontent.com/57972646/111726593-97f37780-88ac-11eb-991f-85974c30362d.png" alt="" /></p>

<h2 id="reference">Reference</h2>

<p>[1] [<a href="https://eugeneyan.com/writing/recommender-systems-baseline-pytorch/">Building a Strong Baseline Recommender in PyTorch, on a Laptop</a></p>

<p>[2] <a href="https://rednose86.tistory.com/10">íŒŒì‹±(Parsing)ê³¼ ì»´íŒŒì¼(Compile)ì˜ ì°¨ì´ì </a></p>
:ET